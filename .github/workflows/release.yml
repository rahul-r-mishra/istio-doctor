name: Release

on:
  push:
    tags:
      - "v*.*.*"          # Trigger on semver tags: v1.0.0, v1.2.3-rc.1, etc.

# Only one release at a time
concurrency:
  group: release
  cancel-in-progress: false

env:
  GO_VERSION: "1.22"
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  contents: write        # create GitHub releases, upload assets
  packages: write        # push to GHCR
  id-token: write        # OIDC for cosign signing
  security-events: write # upload SARIF

jobs:
  # ──────────────────────────────────────────────────────────────────────────
  # 1. Validate the tag and run full test suite before releasing
  # ──────────────────────────────────────────────────────────────────────────
  pre-release-checks:
    name: Pre-release Checks
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.meta.outputs.version }}
      is_prerelease: ${{ steps.meta.outputs.is_prerelease }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # full history for changelog generation

      - name: Extract version metadata
        id: meta
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "version=${TAG}" >> $GITHUB_OUTPUT
          # Mark as pre-release if tag contains -, e.g. v1.0.0-rc.1 or v1.0.0-beta
          if [[ "$TAG" =~ - ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi
          echo "Releasing: ${TAG}"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run tests
        run: go test ./... -race -count=1 -timeout=120s

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

  # ──────────────────────────────────────────────────────────────────────────
  # 2. GoReleaser — cross-compile binaries + create GitHub release
  # ──────────────────────────────────────────────────────────────────────────
  goreleaser:
    name: GoReleaser
    runs-on: ubuntu-latest
    needs: pre-release-checks
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COSIGN_EXPERIMENTAL: "1"

  # ──────────────────────────────────────────────────────────────────────────
  # 3. Docker — build multi-arch image and push to GHCR
  # ──────────────────────────────────────────────────────────────────────────
  docker:
    name: Docker Release
    runs-on: ubuntu-latest
    needs: pre-release-checks
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU (for multi-arch builds)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata (tags, labels)
        id: docker-meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # semver: v1.2.3 → 1.2.3, 1.2, 1, latest
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            # also tag the git SHA for traceability
            type=sha,prefix=sha-
          labels: |
            org.opencontainers.image.title=istio-doctor
            org.opencontainers.image.description=Production-grade Istio debugging for large-scale Kubernetes clusters
            org.opencontainers.image.url=https://github.com/${{ github.repository }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.version=${{ needs.pre-release-checks.outputs.version }}
            org.opencontainers.image.licenses=Apache-2.0

      - name: Build and push Docker image
        id: docker-build
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.docker-meta.outputs.tags }}
          labels: ${{ steps.docker-meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true    # SLSA provenance attestation
          sbom: true          # SBOM attestation

      - name: Sign Docker image with cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign the image digest
        run: |
          cosign sign --yes \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.docker-build.outputs.digest }}
        env:
          COSIGN_EXPERIMENTAL: "1"

  # ──────────────────────────────────────────────────────────────────────────
  # 4. Post-release summary
  # ──────────────────────────────────────────────────────────────────────────
  release-summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [goreleaser, docker]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Release ${{ needs.pre-release-checks.outputs.version || github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| GoReleaser (binaries + GitHub Release) | ${{ needs.goreleaser.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker (GHCR multi-arch) | ${{ needs.docker.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Install" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Binary" >> $GITHUB_STEP_SUMMARY
          echo "curl -Lo istio-doctor https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/istio-doctor_linux_amd64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Docker" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ github.repository }}:${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
